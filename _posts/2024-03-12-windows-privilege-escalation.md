---
title: Windows Privilege Escalation
date: 2024-03-12 03:53:00 -0600
categories: [OSCP]
tags: [oscp, pen200, offsec, certs]     # TAG names should always be lowercase
---
*The Windows Privilege Escalation tools and tactics reviewed here are presented specifically in preparation for the OSCP exam per course suggestions and are by no means replacements for the OSCP training course, nor comprehensive guides for this step in the Kill Chain.*

# Windows Privilege Escalation

We often gain footholds on Windows systems as an unprivileged user. 

## Enumerating Windows

While we may use some technical attack vectors to escalate privileges, it can often be enough to just review information that users and the system leave behind, like when they store passwords in a .txt or when Windows records the input of a password in PowerShell.

### Understanding Windows Privileges and Access Control Mechanisms

Windows security mechanisms of interest include SIDs, access tokens, Mandatory Integrity Control, and User Account Control.

An SID identifies entities/principals that can be authenticated by Windows, like users or groups. Local account and group SIDs are generated by the Local Security Authority (LSA). Domain users and groups have SIDs generated by a Domain Controller (DC). SIDs are created when a user or group is created and cannot be changed.  

SIDs are formmatted like S-R-X-Y:
- S: indicates the string is a SID
- R: revision, always set to 1 since the overall SID structure is still on its initial version
- X: determines the identifier authority that issues the SID. ex: "5" is the most common and specifies the NT Authority. "5" is used for local and domain users and groups.
- Y: represents the sub authorities of the identifier authority. SIDs always have one or more sub authority, and it consists of the domain identifier and the relative identifier (RID). The domain identifier is the domain SID for domain users, the local machine SID for local users, and "32" for built in principals. The RID determines principals like users or groups.

For example, a local user: S-1-5-21-1336799502-1441772794-948155058-1001

The RID in this case is 1001. The RID starts at 1000 for almost all principals, so this implies this is the second local user created on the system.

Well-known SIDs are those that have a RID under 1000, and they identify generic/built-in users and groups instead of specific users and groups. Examples of well-known SIDs:
- S-1-0-0                       Nobody        
- S-1-1-0	                      Everybody
- S-1-5-11                      Authenticated Users
- S-1-5-18                      Local System
- S-1-5-domainidentifier-500    Administrator

Windows determines whether or not to grant operations based on an access token that Windows generated for authenticated users. The token contains several pieces of information that outline the security contrext of a user. Security context refers to the set of rules or attributes that are in effect.

The security context of a token includes the SID of the suer, the SIDs of the users' groups, the user and group privileges, and additional token scope information.

When a user starts a thread or process, a token is assigned to the objects, called a primary token. Primary tokens specify which permission the process will have when interecting with other objects and is a copy of the access token of the user.

Threads can also have an impersonation token assigned, which is used to provide a different security context than the process that owns the thread. Therefore, the threat interacts with objects on behalf of the impersonation token instead of the primary token of the process.

Windows also implementes Mandatory Integrity Control, which uses integrity levels to control access to securable objects. The levels are like hierarchies of trust that Windows has in a running object.

When objects are created or processes are started, they get the intergrity level of the principal performing the action. Executable files with low integrity levels are the exception - the process's integrity will also be low. Principals with low integrity levels cannot write to an object higher on the hierarchy, EVEN if perms would normally allow them to.

Since Windows Vista, processes run on the following integrity levels:
- System: SYSTEM (kernel, ...)
- High: Elevated users
- Medium: Standard users
- Low: Very restricted rights often used in sandboxed[^privesc_win_sandbox] processes or for directories storing temporary data
- Untrusted: Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk

Process Explorer can show us the integrity level of processes
